<!DOCTYPE html>
<canvas width="960" height="600"></cavnas>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://unpkg.com/topojson-client@2"></script>
    <script src="versor.js"></script>
    <script>

        var canvas = d3.select("canvas"),
            width = canvas.property("width"),
            height = canvas.property("height"),
            acontext = canvas.node().getContext("2d");

        var projection = d3.geoOrthographic()
            .scale((height - 10) / 2)
            .translate([width / 2, height / 2])
            .precision(0.1);

        var zoom = d3.zoom()
            .scaleExtent([1, 20])
            .on("zoom", zoomed);

        var svg = d3.select("body").append("svg")
            .attr("width", width)
            .attr("height", height)
            //track where user clicked down
            .on("mousedown", function() {
                d3.event.preventDefault();
                //only if scale === 1
                if(s !== 1) return;
                initX = d3.mouse(this)[0];
                mouseClicked = true;
            })
            .on("mouseup", function() {
                if(s !== 1) return;
                rotated = rotated + ((d3.mouse(this)[0] - initX) * 360 / (s * width));
                mouseClicked = false;
            })
            .call(zoom);

        function rotateMap(endX) {
            projection.rotate([rotated + (endX - initX) * 360 / (s * width),0,0])
            g.selectAll('path')       // re-project path data
                .attr('d', path);
        }

        var path = d3.geoPath()
            .projection(projection)
            .context(context);

        canvas.call(d3.drag()
            .on("start", dragstarted)
            .on("drag", dragged));

        var render = function() {},
            v0, // Mouse position in Cartesian coordinates at start of drag gesture.
            r0, // Projection rotation as Euler angles at start.
            q0; // Projection rotation as versor at start.

        function dragstarted() {
            v0 = versor.cartesian(projection.invert(d3.mouse(this)));
            r0 = projection.rotate();
            q0 = versor(r0);
        }

        function dragged() {
            var v1 = versor.cartesian(projection.rotate(r0).invert(d3.mouse(this))),
                q1 = versor.multiply(q0, versor.delta(v0, v1)),
                r1 = versor.rotation(q1);
            projection.rotate(r1);
            render();
        }

        d3.json("https://gist.githubusercontent.com/tdreyno/4278655/raw/7b0762c09b519f40397e4c3e100b097d861f5588/airports.json", function(error, data) {

            // Handle errors getting and parsing the data
            if (error) { return error; }

            // setting the circle size (not radius!) according to the number of inhabitants per city
            // airports_array = [];
            // for (i = 0; i < data.length; i++) {
            //    airports_array.push(data.features[i].properties.population);
            // }

            console.log(data)




            // Drawing transparent circle markers for cities
            // g.selectAll("path.cities").data(data.features)
            //     .enter().append("path")
            //     .attr("class", "cities")
            //    .attr("d", path)
            //     .attr("fill", "#ffba00")
            //     .attr("fill-opacity", 0.3);

            // start spinning!
            //spinning_globe();
        });

        // d3.json("https://unpkg.com/us-atlas@1/us/10m.json", function(error, us) {
        //   if (error) throw error;

        //    var sphere = {type: "Sphere"},
        //        states = topojson.feature(us, us.objects.states,function(a, b) { return a !== b; });
        //   render = function() {
        // 	  context.beginPath(), path(states), context.fillStyle = "#f5fffa", context.fill(), context.stroke(), context.lineWidth = 0.35;
        // 	};

        // 	render();
        // });

        d3.json("combined.json", function(error, world) {
            if (error) throw error;

            var sphere = {type: "Sphere"},
                land = topojson.feature(world, world.objects.countries);

            render = function() {
                context.clearRect(0, 0, width, height);
                context.beginPath(), path(sphere), context.fillStyle = "#f0f8ff", context.fill();
                context.beginPath(), path(land), context.fillStyle = "#f5fffa", context.fill(), context.stroke(), context.lineWidth = 0.35;
                context.beginPath(), path(sphere), context.stroke();
            };

            render();
        });

        function rotateMap(endX) {
            projection.rotate([rotated + (endX - initX) * 360 / (s * width),0,0])
            g.selectAll('path')       // re-project path data
                .attr('d', path);
        }

        function zoomed() {
            var t = d3.event.translate;
            s = d3.event.scale;
            var h = 0;
            t[0] = Math.min(
                (width/height)  * (s - 1),
                Math.max( width * (1 - s), t[0] )
            );
            t[1] = Math.min(
                h * (s - 1) + h * s,
                Math.max(height  * (1 - s) - h * s, t[1])
            );
            zoom.translate(t);
            if(s === 1 && mouseClicked) {
                rotateMap(d3.mouse(this)[0])
                return;
            }
            g.attr("transform", "translate(" + t + ")scale(" + s + ")");
            //adjust the stroke width based on zoom level
            d3.selectAll(".boundary")
                .style("stroke-width", 1 / s);

            //toggle state/USA visability
            if(s > 1.5) {
                states
                    .classed('hidden', false);
                usa
                    .classed('hidden', true);
                canada
                    .classed('hidden', true);
            } else {
                states
                    .classed('hidden', true);
                usa
                    .classed('hidden', false);
                canada
                    .classed('hidden', false);
            }
        }

    </script>